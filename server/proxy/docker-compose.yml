services:

    tailscale:
        image: tailscale/tailscale:latest
        volumes:
            - "./tailscale/var_lib:/var/lib"        # State data will be stored in this directory
            - "/dev/net/tun:/dev/net/tun"           # Required for tailscale to work 
        cap_add:                                    # Required for tailscale to work
            - net_admin
            - sys_module
        command: tailscaled
        ports:
            - "8880:80"
        environment:
            - TS_EXTRA_ARGS=--login-server=https://cloud.elec.ac.nz
            - TS_HOSTNAME=telescope_proxy            # Will resolve to proxy.tart.telescopes.elec.ac.nz
            - TS_STATE_DIR=/var/lib/tailscale

        restart: unless-stopped
      

    headscale_proxy:
        image: caddy:latest
        container_name: headscale_proxy
        network_mode: "service:tailscale"
        restart: unless-stopped
        security_opt:
            - label:disable
        # ports:
        #     - "80:80"
        #     - "443:443"
        #     - "443:443/udp"
        volumes:
            - caddy_data:/data
            - caddy_config:/config
            - ./caddy_etc:/etc/caddy
            - /etc/localtime:/etc/localtime:ro

volumes:
  caddy_data:
    external: true
  caddy_config:
