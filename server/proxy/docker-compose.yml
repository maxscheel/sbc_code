services:

    ts-proxy:
        image: tailscale/tailscale:latest
        container_name: ts-proxy
        hostname: telescope-proxy
        volumes:
            - "./ts-proxy/state:/var/lib/tailscale"        # State data will be stored in this directory
            - "/dev/net/tun:/dev/net/tun"           # Required for tailscale to work 
        cap_add:                                    # Required for tailscale to work
            - net_admin
            - sys_module
        ports:
            - "8880:80"
        environment:
            # - TS_ACCEPT_DNS=true
            # - TS_USERSPACE=false
            # - TS_EXTRA_ARGS=--login-server=https://cloud.elec.ac.nz
            - TS_HOSTNAME=telescope-proxy            # Will resolve to proxy.tart.telescopes.elec.ac.nz
            - TS_STATE_DIR=/var/lib/tailscale
    
        restart: unless-stopped
      

    # Automatic Proxy which will resolve the VIRTUAL_HOST to the container specified.
#         Get an auth_key
#         	docker compose -f proxy-compose.yml exec tailscale tailscale up --login-server http://cloud.elec.ac.nz:51820 --hostname=proxy --authkey ${AUTH_KEY}
#         
#         Only proxy hosts on the headscale network...
    nginx:
        image: nginx
        network_mode: "service:ts-proxy"
        restart: always
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
            - ./nginx/html:/var/www/html
            - ~/cache:/cache
        depends_on:
            - ts-proxy
        logging:
            driver: "json-file"
            options:
                max-file: "5"
                max-size: "1m"

    # # Purely for testing
    # tester:
    #     build:
    #         context: .
    #         dockerfile: Dockerfile.tester
    #     ports:
    #         - "8880:80"
    #     tmpfs:
    #         - /tmp
    #         - /run
    #         - /run/lock
    #     # cap_add:                                    # Required for tailscale to work
    #     #     - net_admin
    #     #     - sys_module
    #     volumes:
    #          - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    #          - ./nginx/html:/var/www/html
    #          - ~/cache:/cache
    #          - "./ts-proxy/state:/var/lib/tailscale"        # State data will be stored in this directory
    #          - "/dev/net/tun:/dev/net/tun"           # Required for tailscale to work 
    #          - /sys/fs/cgroup:/sys/fs/cgroup:ro      # Required for systemd in debian
    #     environment:
    #         # - TS_ACCEPT_DNS=true
    #         # - TS_USERSPACE=false
    #         - TS_EXTRA_ARGS=--login-server=https://cloud.elec.ac.nz
    #         - TS_HOSTNAME=telescope-proxy            # Will resolve to proxy.tart.telescopes.elec.ac.nz
    #         - TS_STATE_DIR=/var/lib/tailscale
        # network_mode: "service:ts-proxy"
        # depends_on:
        #     - ts-proxy
    # headscale_proxy:
    #     image: caddy:latest
    #     network_mode: "service:tailscale"
    #     restart: unless-stopped
    #     security_opt:
    #         - label:disable
    #     ports:
    #         - "80:80"
    #         - "443:443"
    #         - "443:443/udp"
    #     volumes:
    #         - caddy_data:/data
    #         - caddy_config:/config
    #         - ./caddy_etc:/etc/caddy
    #         - /etc/localtime:/etc/localtime:ro

volumes:
  caddy_data:
    external: true
  caddy_config:
